<html>

<head>
    <title>Section Tags Example</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta property="og:title" content="Section Tags Example" />
    <meta property="og:description" content="An interactive story written in Fractive" />
    <meta name="twitter:card" content="summary" />

    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet"></link>
    <style>
        #__controls {
            position: fixed;
            top: 0px;
            left: 0px;
            width: calc(100% - 80px);
            height: 75px;
            padding: 0px 40px;
            background-color: #333333;
            color: #BBBBBB;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 13pt;
        }

        #__controls .controls-left {
            float: left;
            text-align: left;
        }

        #__controls .controls-right {
            float: right;
            text-align: right;
        }

        #__controls a:link,
        #__controls a:visited {
            color: #FAFAFA;
            text-decoration: none;
        }

        #__controls a:active,
        #__controls a:hover {
            color: #FF6666;
            text-decoration: none;
        }

        #__historyContainer {
            position: fixed;
            top: 75px;
            left: 0px;
            height: 400px;
            width: 100%;
            overflow: auto;
            background-color: #333333;
        }

        #__history * {
            max-width: 750px !important;
            margin-left: auto !important;
            margin-right: auto !important;
            color: #777777 !important;
            font-family: Arial, Helvetica, sans-serif !important;
            font-size: 13pt !important;
        }

        #__history .__inlineMacro {
            animation: none;
            color: #777777;
        }

        .__disabledLink {
            color: #777777;
            text-decoration: underline;
        }

        #__content {
            position: absolute;
            top: 75px;
            left: 0px;
            width: 100%;
            overflow: auto;
        }

        #__currentSection {
            color: #555555;
            animation: 1s textFadeIn;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        @keyframes textFadeIn {
            from {
                color: #FAFAFA;
            }
            to {
                color: #555555;
            }
        }

        .__inlineMacro {
            animation: 1s inlineMacroFadeIn;
            color: #a7826a;
        }

        @keyframes inlineMacroFadeIn {
            from {
                color: #FAFAFA;
            }
            to {
                color: #a7826a;
            }
        }

        h1 {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 56pt;
            text-transform: none;
            margin-top: 28pt;
            margin-bottom: -4pt;
            line-height: 0.9em;
        }

        h2 {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 38pt;
            text-transform: none;
            margin-top: 19pt;
            margin-bottom: -12pt;
        }

        h3 {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 22pt;
            text-transform: uppercase;
            margin-top: 11pt;
            margin-bottom: -8pt;
        }

        body {
            background-color: #FAFAFA;
        }

        p {
            text-transform: none;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 16pt;
            line-height: 1.5em;
        }

        a:link,
        a:visited {
            color: #6666FF;
        }

        a:active,
        a:hover {
            color: #FF6666;
        }

        li {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 16pt;
            line-height: 1.5em;
            margin-left: 20px;
        }

        blockquote p {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 16pt;
            font-style: italic;
            line-height: 1.5em;
        }

        pre {
            font-family: "Courier New", "Courier", monospace;
            font-size: 14pt;
            background-color: #333333;
            color: #BBBBBB;
            line-height: 1.5em;
            padding: 10px 20px;
            max-height: 600px;
            overflow: auto;
        }

        img {
            margin: 20px 0px;
        }

        hr {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.75), rgba(0, 0, 0, 0));
            margin-top: 36pt;
            margin-bottom: 36pt;
        }
    </style>
    <script type='text/javascript'>
        (function() {
            function r(e, n, t) {
                function o(i, f) {
                    if (!n[i]) {
                        if (!e[i]) {
                            var c = "function" == typeof require && require;
                            if (!f && c) return c(i, !0);
                            if (u) return u(i, !0);
                            var a = new Error("Cannot find module '" + i + "'");
                            throw a.code = "MODULE_NOT_FOUND", a
                        }
                        var p = n[i] = {
                            exports: {}
                        };
                        e[i][0].call(p.exports, function(r) {
                            var n = e[i][1][r];
                            return o(n || r)
                        }, p, p.exports, r, e, n, t)
                    }
                    return n[i].exports
                }
                for (var u = "function" == typeof require && require, i = 0; i < t.length; i++) o(t[i]);
                return o
            }
            return r
        })()({
            1: [function(require, module, exports) {
                Core.AddEventListener("OnGotoSection", function(id, element, tags, reason) {
                    if (reason !== Core.EGotoSectionReason.Goto) {
                        return;
                    }

                    var currentSection = document.getElementById('__currentSection');

                    // One method of replacement is just to edit the innerHTML/outerHTML property directly.
                    // This regenerates DOM elements which means we lose subscribed event handlers. Core
                    // deals with this using a MutationObserver which detects the change to __currentSection
                    // and reregisters these handlers. User code would be another story...
                    if (tags.indexOf("Tutorial") !== -1) {
                        currentSection.innerHTML += "<p>Click on links to read through the story.";
                    }

                    // A safer method of replacement is to work with elements instead of html, and only
                    // touch what you need to touch. This way we don't regenerate *everything* in the
                    // __currentSection so we'll preserve subscribed event handlers, at least on elements
                    // we don't delete or replace here. Core detects these changes as well.
                    if (tags.indexOf("Person1") !== -1) {
                        var i = document.createElement("img");
                        i.src = "assets/person1.png";
                        currentSection.insertBefore(i, currentSection.firstChild);
                    }
                    if (tags.indexOf("Person2") !== -1) {
                        var i = document.createElement("img");
                        i.src = "assets/person2.png";
                        currentSection.insertBefore(i, currentSection.firstChild);
                    }
                });

            }, {}],
            2: [function(require, module, exports) {
                "use strict";
                Object.defineProperty(exports, "__esModule", {
                    value: true
                });
                var Core;
                (function(Core) {
                    var EGotoSectionReason;
                    (function(EGotoSectionReason) {
                        EGotoSectionReason[EGotoSectionReason["Goto"] = 0] = "Goto";
                        EGotoSectionReason[EGotoSectionReason["Back"] = 1] = "Back";
                        EGotoSectionReason[EGotoSectionReason["Refresh"] = 2] = "Refresh";
                    })(EGotoSectionReason = Core.EGotoSectionReason || (Core.EGotoSectionReason = {}));
                    var OnBeginStory = [];
                    var OnGotoSection = [];
                    var currentSectionObserver = new MutationObserver(OnCurrentSectionModified);
                    var currentSectionObserverConfig = {
                        childList: true,
                        attributes: true,
                        characterData: true,
                        subtree: true
                    };

                    function ActivateElement(element) {
                        if (element.tagName && element.tagName.toLowerCase() == "a") {
                            var _loop_1 = function(i) {
                                switch (element.attributes[i].name) {
                                    case "data-goto-section":
                                        {
                                            element.addEventListener("click", function() {
                                                Core.GotoSection(element.attributes[i].value);
                                            });
                                            break;
                                        }
                                    case "data-call-function":
                                        {
                                            element.addEventListener("click", RetrieveFromWindow(element.attributes[i].value, 'function'));
                                            break;
                                        }
                                    case "data-replace-with":
                                        {
                                            element.addEventListener("click", function() {
                                                Core.ReplaceActiveElement(element.id, ExpandMacro(element.attributes[i].value));
                                            });
                                            break;
                                        }
                                }
                            };
                            for (var i = 0; i < element.attributes.length; i++) {
                                _loop_1(i);
                            }
                        }
                        if (element.id && element.id !== "__currentSection") {
                            if (element.id[0] !== '!') {
                                element.id = "!" + element.id;
                            }
                        }
                        if (element.children) {
                            for (var i = 0; i < element.children.length; i++) {
                                ActivateElement(element.children[i]);
                            }
                        }
                    }
                    Core.ActivateElement = ActivateElement;

                    function AddEventListener(eventName, handler) {
                        switch (eventName) {
                            case "OnBeginStory":
                                {
                                    OnBeginStory = OnBeginStory.concat(handler);
                                    break;
                                }
                            case "OnGotoSection":
                            case "OnGoToSection":
                                {
                                    OnGotoSection = OnGotoSection.concat(handler);
                                    break;
                                }
                            default:
                                {
                                    console.error("Core.AddEventListener: \"" + eventName + "\" is not a valid event");
                                    break;
                                }
                        }
                    }
                    Core.AddEventListener = AddEventListener;

                    function BeginStory() {
                        for (var i = 0; i < OnBeginStory.length; i++) {
                            OnBeginStory[i]();
                        }
                        var startSections = GetSectionsWithTag("Start");
                        if (startSections.length == 0) {
                            console.error("BeginStory(): no section is defined with the Start tag.");
                        } else if (startSections.length > 1) {
                            console.error("BeginStory(): multiple sections defined with the Start tag.");
                        } else {
                            GotoSection(startSections[0]);
                        }
                    }
                    Core.BeginStory = BeginStory;

                    function CanBeInline(html, context) {
                        var root = document.createElement("span");
                        if (context) {
                            context.appendChild(root);
                        } else {
                            document.appendChild(root);
                        }
                        root.innerHTML = html;
                        var scan = function(e) {
                            if (getComputedStyle(e, "").display === "block") {
                                return false;
                            }
                            for (var i = 0; i < e.children.length; i++) {
                                if (scan(e.children[i]) === false) {
                                    return false;
                                }
                            }
                            return true;
                        };
                        var result = scan(root);
                        if (context) {
                            context.removeChild(root);
                        } else {
                            document.removeChild(root);
                        }
                        return result;
                    }

                    function DisableLinks(section) {
                        var links = section.getElementsByTagName("a");
                        for (var i = 0; i < links.length; i++) {
                            var linkTag = links[i].outerHTML.substring(0, links[i].outerHTML.indexOf(">") + 1);
                            var contents = links[i].outerHTML.substring(links[i].outerHTML.indexOf(">") + 1, links[i].outerHTML.indexOf("</a>"));
                            links[i].outerHTML = "<span class=\"__disabledLink\" data-link-tag='" + linkTag + "'>" + contents + "</span>";
                        }
                    }

                    function EnableLinks(section) {
                        var links = section.getElementsByClassName("__disabledLink");
                        for (var i = 0; i < links.length;) {
                            var linkTag = links[i].getAttribute('data-link-tag');
                            var contents = links[i].innerHTML;
                            links[i].outerHTML = linkTag + contents + '</a>';
                        }
                    }

                    function ExpandMacro(macro) {
                        switch (macro[0]) {
                            case '@':
                                {
                                    var sectionName = macro.substring(1);
                                    if (!document.getElementById(sectionName)) {
                                        return "{section \"" + sectionName + "\" is not declared}";
                                    } else {
                                        return ExpandSection(macro.substring(1)).innerHTML;
                                    }
                                }
                            case '#':
                                {
                                    var functionName = macro.substring(1);
                                    var targetFunction = RetrieveFromWindow(functionName, 'function');
                                    if (targetFunction !== null && targetFunction !== undefined) {
                                        var result = targetFunction();
                                        return (result ? result.toString() : "");
                                    } else {
                                        return "{function \"" + functionName + "\" is not defined}";
                                    }
                                }
                            case '$':
                                {
                                    var variableName = macro.substring(1);
                                    var targetVariable = RetrieveFromWindow(variableName, 'variable');
                                    if (targetVariable !== null && targetVariable !== undefined) {
                                        return targetVariable.toString();
                                    } else {
                                        return "{variable \"" + variableName + "\" is not defined}";
                                    }
                                }
                            default:
                                {
                                    return "{unknown metacharacter in macro \"" + macro + "\"";
                                }
                        }
                    }
                    Core.ExpandMacro = ExpandMacro;

                    function ExpandSection(id) {
                        var source = document.getElementById(id);
                        if (source === null) {
                            console.log("Section " + id + " doesn't exist");
                            return null;
                        }
                        var sectionInstance = source.cloneNode(true);
                        sectionInstance.removeAttribute("hidden");
                        var scan = function(element) {
                            for (var i = 0; i < element.attributes.length; i++) {
                                var expanded = false;
                                switch (element.attributes[i].name) {
                                    case "data-expand-macro":
                                        {
                                            if (element.parentElement) {
                                                var newElement = document.createElement("span");
                                                newElement.innerHTML = ExpandMacro(element.attributes[i].value);
                                                element.parentElement.replaceChild(newElement, element);
                                                expanded = true;
                                            }
                                            break;
                                        }
                                    case "data-image-source-macro":
                                        {
                                            element.setAttribute("src", ExpandMacro(element.attributes[i].value));
                                            expanded = true;
                                        }
                                }
                                if (expanded) {
                                    break;
                                }
                            }
                            if (element.hasChildNodes) {
                                for (var i = 0; i < element.children.length; i++) {
                                    scan(element.children[i]);
                                }
                            }
                        };
                        scan(sectionInstance);
                        return sectionInstance;
                    }

                    function GetCurrentSectionTags() {
                        return GetSectionTags("__currentSection");
                    }
                    Core.GetCurrentSectionTags = GetCurrentSectionTags;

                    function GetSection(id) {
                        var clone = ExpandSection(id);
                        clone.setAttribute('data-id', id);
                        return clone;
                    }
                    Core.GetSection = GetSection;

                    function GetSectionsWithTag(tag) {
                        var matchingSections = [];
                        var sections = document.getElementsByClassName("section");
                        for (var i = 0; i < sections.length; ++i) {
                            var sectionId = sections[i].getAttribute('id');
                            var sectionTags = GetSectionTags(sectionId);
                            if (sectionTags.indexOf(tag) !== -1) {
                                matchingSections.push(sectionId);
                            }
                        }
                        return matchingSections;
                    }
                    Core.GetSectionsWithTag = GetSectionsWithTag;

                    function GetSectionTags(id) {
                        var sectionDiv = document.getElementById(id);
                        var tagDeclarations = sectionDiv.getAttribute("data-tags");
                        return tagDeclarations.split(',');
                    }
                    Core.GetSectionTags = GetSectionTags;

                    function GotoPreviousSection() {
                        currentSectionObserver.disconnect();
                        var history = document.getElementById("__history");
                        if (history === null) {
                            console.error("History is not supported in this template (the __history element is missing)");
                            return;
                        }
                        var previousSections = history.getElementsByClassName('__previousSection');
                        var previousSection = previousSections[previousSections.length - 1];
                        if (!previousSection) {
                            return;
                        }
                        var id = previousSection.getAttribute('data-id');
                        var clone = previousSection.cloneNode(true);
                        EnableLinks(clone);
                        SetElementAsCurrentSection(clone);
                        for (var i = 0; i < OnGotoSection.length; i++) {
                            OnGotoSection[i](id, clone, GetSectionTags(id), EGotoSectionReason.Back);
                        }
                        history.removeChild(previousSection);
                    }
                    Core.GotoPreviousSection = GotoPreviousSection;

                    function GoToPreviousSection() {
                        GotoPreviousSection();
                    }
                    Core.GoToPreviousSection = GoToPreviousSection;

                    function GotoSection(id) {
                        currentSectionObserver.disconnect();
                        var currentSection = document.getElementById("__currentSection");
                        DisableLinks(currentSection);
                        var history = document.getElementById("__history");
                        var previousSectionId = currentSection.getAttribute('data-id');
                        if (previousSectionId !== null && history !== null) {
                            history.innerHTML += "<div class=\"__previousSection\" data-id=\"" + previousSectionId + "\">" + currentSection.innerHTML + "</div>";
                            history.scrollTop = history.scrollHeight;
                        }
                        var clone = GetSection(id);
                        SetElementAsCurrentSection(clone);
                        for (var i = 0; i < OnGotoSection.length; i++) {
                            OnGotoSection[i](id, clone, GetSectionTags(id), EGotoSectionReason.Goto);
                        }
                    }
                    Core.GotoSection = GotoSection;

                    function GoToSection(id) {
                        GotoSection(id);
                    }
                    Core.GoToSection = GoToSection;

                    function OnCurrentSectionModified(mutations) {
                        for (var i = 0; i < mutations.length; i++) {
                            for (var j = 0; j < mutations[i].addedNodes.length; j++) {
                                var e = mutations[i].addedNodes[j];
                                ActivateElement(e);
                            }
                        }
                    }

                    function RefreshCurrentSection() {
                        currentSectionObserver.disconnect();
                        var currentSection = document.getElementById("__currentSection");
                        var id = currentSection.getAttribute("data-id");
                        var clone = GetSection(id);
                        SetElementAsCurrentSection(clone);
                        for (var i = 0; i < OnGotoSection.length; i++) {
                            OnGotoSection[i](id, clone, GetSectionTags(id), EGotoSectionReason.Refresh);
                        }
                    }
                    Core.RefreshCurrentSection = RefreshCurrentSection;

                    function RetrieveFromWindow(name, type) {
                        var targetObject = null;
                        var tokens = name.split('.');
                        for (var i = 0; i < tokens.length; i++) {
                            if (i === 0) {
                                targetObject = window[tokens[0]];
                            } else {
                                targetObject = targetObject[tokens[i]];
                            }
                        }
                        if (targetObject === undefined) {
                            return "{" + type + " \"" + name + "\" is not declared}";
                        }
                        return targetObject;
                    }

                    function ReplaceActiveElement(id, html) {
                        var element = document.getElementById(id[0] === '!' ? id : "!" + id);
                        if (!element) {
                            return;
                        }
                        var replacement = document.createElement(CanBeInline(html, element.parentElement) ? "span" : "div");
                        replacement.className = "__inlineMacro";
                        replacement.innerHTML = html;
                        ActivateElement(replacement);
                        element.parentNode.replaceChild(replacement, element);
                    }
                    Core.ReplaceActiveElement = ReplaceActiveElement;

                    function SetElementAsCurrentSection(e) {
                        var currentSection = document.getElementById("__currentSection");
                        e.scrollTop = 0;
                        e.id = "__currentSection";
                        ActivateElement(e);
                        currentSection.parentElement.replaceChild(e, currentSection);
                        currentSectionObserver.observe(e, currentSectionObserverConfig);
                    }
                })(Core = exports.Core || (exports.Core = {}));
                window['Core'] = Core;

            }, {}]
        }, {}, [2, 1]);
    </script>
</head>

<body>
    <div id="__content">
        <!-- source/text.md -->
        <div id="SectionTags" data-tags="Start,Tutorial" class="section" hidden="true">
            <h1>The joy of tagging sections!</h1>
            <p>This example shows some of the cool things you can do with section tags.<br/>(Not to be confused with link tags).</p>
            <p>Section tags are applied to a section declaration like this: <code>{{SectionName: tag1, tag2}}</code></p>
            <p>You can use the following functions in <code>Core</code> to play around with tags:</p>
            <ul>
                <li><code>Core.GetSectionTags(id)</code></li>
                <li><code>Core.GetCurrentSectionTags()</code></li>
                <li><code>Core.GetSectionsWithTag(tags)</code></li>
            </ul>
            <p>You can also write functions that will be called automatically when your reader<br/>goes to a new section, like this:</p>
            <pre><code>Core.AddEventListener(&quot;OnGotoSection&quot;, function(id, element, tags, reason)
{
	if (tags.indexOf(&quot;Tutorial&quot;) !== -1)
	{
		document.getElementById('__currentSection').innerHTML += `&lt;p&gt;Click on links to read through the story.&lt;/p&gt;`;
	}
});
</code></pre>
            <p><a title="{@OtherIdeas}" href="javascript:;" data-goto-section="OtherIdeas">What else can you do with section tags?</a></p>
            <p>In this story, as a result of the code above, every section we tagged with <code>Tutorial</code><br/>will be followed by a short tutorial message.</p>
        </div>
        <div id="OtherIdeas" data-tags="Person1" class="section" hidden="true">
            <p>You could use section tags to list images that need to be displayed next to<br/>each section.</p>
            <p><a title="{@Conversation2}" href="javascript:;" data-goto-section="Conversation2">Next</a></p>
        </div>
        <div id="Conversation2" data-tags="Person2" class="section" hidden="true">
            <p>These tags could include a different background, or multiple character portraits,<br/>for each section of a visual novel.</p>
        </div>

        <div id="__currentSection">
            <noscript>
					<h1>Oh no!</h1>
					<p>Fractive requires Javascript to run, but Javascript is currently disabled.</p>
					<p>Please check your browser and plugin settings. You may need to enable Javascript in your browser and/or whitelist this URL in your script blocker if you're using one.</p>
				</noscript>
        </div>
    </div>
    <div id="__historyContainer" hidden>
        <div id="__history"></div>
    </div>
    <div id="__controls">
        <p class="controls-left">
            <a href="javascript:Core.GotoPreviousSection();"><i class="fa fa-arrow-left" aria-hidden="true"></i> Back</a>
        </p>
        <p class="controls-right">
            <a href="#" onclick="__Restart()">Restart</a> -
            <a href="#" onclick="__ToggleHistory()">Toggle History</a>
        </p>
    </div>
</body>

</html>
<script>
    Core.BeginStory();
</script>